# Dernek Y√∂neticisi Yetki Analizi

**Tarih:** 2025-10-03  
**Analiz Eden:** Augment Agent  
**Konu:** Dernek y√∂neticisinin √ºye bilgilerini g√ºncelleme yetkisi

---

## üìä Y√∂netici √ñzeti

SQL tablolarƒ±nƒ± ve backend kodunu inceledim. Dernek y√∂neticisinin √ºye bilgilerini g√ºncelleme yetkisi **teorik olarak VAR** ancak bu yetki **API seviyesinde kontrol edilmiyor**. Bu ciddi bir g√ºvenlik a√ßƒ±ƒüƒ±dƒ±r.

---

## ‚úÖ Mevcut Durum: Yetki Tanƒ±mƒ±

### üîë Verilen Yetkiler

**Dosya:** `verein-api/Controllers/AuthController.cs` (Satƒ±r 80)

```csharp
if (isVereinAdmin)
{
    return Ok(new LoginResponseDto
    {
        UserType = "dernek",
        FirstName = mitglied.Vorname,
        LastName = mitglied.Nachname,
        Email = mitglied.Email,
        VereinId = mitglied.VereinId,
        MitgliedId = mitglied.Id,
        Permissions = new[] { 
            "verein.read",        // Dernek okuma
            "verein.update",      // Dernek g√ºncelleme
            "mitglied.all",       // √úYE T√úM YETKƒ∞LER ‚úÖ
            "veranstaltung.all"   // Etkinlik t√ºm yetkiler
        }
    });
}
```

### üìã Yetki Kapsamƒ±

**`"mitglied.all"`** yetkisi teorik olarak ≈üunlarƒ± kapsar:
- ‚úÖ √úye olu≈üturma (Create)
- ‚úÖ √úye okuma (Read)
- ‚úÖ √úye g√ºncelleme (Update)
- ‚úÖ √úye silme (Delete)
- ‚úÖ √úye aktif/pasif yapma
- ‚úÖ √úye transfer etme

---

## ‚ö†Ô∏è G√ºvenlik A√ßƒ±klarƒ±

### üö® 1. Controller'larda Authorization Yok

**Dosya:** `verein-api/Controllers/MitgliederController.cs`

```csharp
[ApiController]
[Route("api/[controller]")]
[Produces("application/json")]
public class MitgliederController : ControllerBase
{
    // ‚ùå [Authorize] attribute YOK!
    // ‚ùå [RequirePermission("mitglied.all")] gibi bir kontrol YOK!
    
    /// <summary>
    /// Update existing Mitglied
    /// </summary>
    [HttpPut("{id:int}")]
    public async Task<ActionResult<MitgliedDto>> Update(
        int id,
        [FromBody] UpdateMitgliedDto updateDto,
        CancellationToken cancellationToken = default)
    {
        // Herkes bu endpoint'e eri≈üebilir!
        // Yetki kontrol√º yapƒ±lmƒ±yor!
    }
}
```

**Etkilenen Endpoint'ler:**
- `GET /api/Mitglieder` - T√ºm √ºyeleri listele
- `GET /api/Mitglieder/{id}` - √úye detayƒ±
- `GET /api/Mitglieder/verein/{vereinId}` - Dernek √ºyelerini listele
- `POST /api/Mitglieder` - Yeni √ºye olu≈ütur
- `PUT /api/Mitglieder/{id}` - √úye g√ºncelle
- `DELETE /api/Mitglieder/{id}` - √úye sil
- `POST /api/Mitglieder/{id}/transfer` - √úye transfer et
- `POST /api/Mitglieder/{id}/set-active` - √úye aktif/pasif yap

### üö® 2. Database'de User/Role/Permission Tablolarƒ± Yok

**Dosya:** `verein-api/Data/ApplicationDbContext.cs`

Mevcut tablolar:
```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);

    // Apply entity configurations
    modelBuilder.ApplyConfiguration(new VereinConfiguration());
    modelBuilder.ApplyConfiguration(new AdresseConfiguration());
    modelBuilder.ApplyConfiguration(new BankkontoConfiguration());
    modelBuilder.ApplyConfiguration(new VeranstaltungConfiguration());
    modelBuilder.ApplyConfiguration(new VeranstaltungAnmeldungConfiguration());
    modelBuilder.ApplyConfiguration(new VeranstaltungBildConfiguration());
    modelBuilder.ApplyConfiguration(new MitgliedConfiguration());
    modelBuilder.ApplyConfiguration(new MitgliedAdresseConfiguration());
    modelBuilder.ApplyConfiguration(new MitgliedFamilieConfiguration());
}
```

**Eksik Tablolar:**
- ‚ùå `User` - Kullanƒ±cƒ± tablosu
- ‚ùå `Role` - Rol tablosu (Admin, Dernek, Mitglied)
- ‚ùå `Permission` - Yetki tablosu
- ‚ùå `UserRole` - Kullanƒ±cƒ±-Rol ili≈üki tablosu
- ‚ùå `RolePermission` - Rol-Yetki ili≈üki tablosu

**Mevcut Domain Tablolar:**
- ‚úÖ `Verein` - Dernekler
- ‚úÖ `Mitglied` - √úyeler
- ‚úÖ `Veranstaltung` - Etkinlikler
- ‚úÖ `Adresse` - Adresler
- ‚úÖ `Bankkonto` - Banka hesaplarƒ±
- ‚úÖ `MitgliedAdresse` - √úye adresleri
- ‚úÖ `MitgliedFamilie` - √úye aile ili≈ükileri
- ‚úÖ `VeranstaltungAnmeldung` - Etkinlik kayƒ±tlarƒ±

### üö® 3. JWT Token Doƒürulama Yok

**Dosya:** `verein-api/Program.cs`

```csharp
// ‚ùå JWT Authentication middleware YOK
// ‚ùå app.UseAuthentication() √ßaƒürƒ±sƒ± YOK
// ‚ùå app.UseAuthorization() √ßaƒürƒ±sƒ± YOK
```

### üö® 4. Frontend'de Sadece UI Kontrol√º Var

**Dosya:** `verein-web/src/contexts/AuthContext.tsx`

```typescript
export interface User {
  type: UserType;
  firstName: string;
  lastName: string;
  email: string;
  permissions: string[];
  vereinId?: number;
  mitgliedId?: number;
}

interface AuthContextType {
  hasPermission: (permission: string) => boolean;
  // ...
}
```

**Sorun:** `hasPermission()` fonksiyonu sadece **butonlarƒ± gizliyor**, API'yi korumaz!

√ñrnek kullanƒ±m:
```typescript
{hasPermission('mitglied.all') && (
  <button onClick={handleEdit}>D√ºzenle</button>
)}
```

Bu sadece UI'da butonu gizler, ama kullanƒ±cƒ± doƒürudan API'ye request atabilir!

---

## üìä G√ºvenlik A√ßƒ±ƒüƒ± √ñzeti

| Kriter | Durum | A√ßƒ±klama |
|--------|-------|----------|
| **Yetki Tanƒ±mƒ±** | ‚úÖ VAR | `"mitglied.all"` dernek y√∂neticisine verilmi≈ü |
| **API Kontrol√º** | ‚ùå YOK | Controller'larda authorization attribute yok |
| **JWT Token** | ‚ùå YOK | Token doƒürulama yapƒ±lmƒ±yor |
| **Database Yapƒ±sƒ±** | ‚ùå YOK | User/Role/Permission tablolarƒ± yok |
| **Middleware** | ‚ùå YOK | Authentication/Authorization middleware yok |
| **Frontend Kontrol√º** | ‚ö†Ô∏è ZAYIF | Sadece UI kontrol√º var, API korumasƒ±z |
| **G√ºvenlik Seviyesi** | üö® KRƒ∞Tƒ∞K | Herkes her endpoint'e eri≈üebilir |

---

## üéØ Risk Senaryolarƒ±

### Senaryo 1: Yetkisiz √úye G√ºncelleme
```bash
# Herhangi bir kullanƒ±cƒ± (hatta giri≈ü yapmamƒ±≈ü biri bile):
curl -X PUT http://localhost:5103/api/Mitglieder/1 \
  -H "Content-Type: application/json" \
  -d '{
    "vorname": "Hacker",
    "nachname": "User",
    "email": "hacker@example.com"
  }'
```
**Sonu√ß:** ‚úÖ ƒ∞stek ba≈üarƒ±lƒ±! √úye bilgileri g√ºncellendi!

### Senaryo 2: Yetkisiz √úye Silme
```bash
curl -X DELETE http://localhost:5103/api/Mitglieder/1
```
**Sonu√ß:** ‚úÖ ƒ∞stek ba≈üarƒ±lƒ±! √úye silindi!

### Senaryo 3: Yetkisiz Veri Okuma
```bash
curl http://localhost:5103/api/Mitglieder
```
**Sonu√ß:** ‚úÖ ƒ∞stek ba≈üarƒ±lƒ±! T√ºm √ºyelerin bilgileri d√∂nd√º!

---

## üí° √á√∂z√ºm √ñnerileri

### 1. JWT Authentication Ekle

**Dosya:** `verein-api/Program.cs`

```csharp
// JWT Authentication ekle
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = builder.Configuration["Jwt:Issuer"],
            ValidAudience = builder.Configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"]))
        };
    });

// Middleware ekle
app.UseAuthentication();
app.UseAuthorization();
```

### 2. Controller'lara Authorization Ekle

**Dosya:** `verein-api/Controllers/MitgliederController.cs`

```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize] // ‚úÖ T√ºm endpoint'ler i√ßin authentication gerekli
public class MitgliederController : ControllerBase
{
    [HttpPut("{id:int}")]
    [RequirePermission("mitglied.all")] // ‚úÖ √ñzel yetki kontrol√º
    public async Task<ActionResult<MitgliedDto>> Update(...)
    {
        // Sadece yetkili kullanƒ±cƒ±lar eri≈üebilir
    }
}
```

### 3. Custom Permission Attribute Olu≈ütur

**Yeni Dosya:** `verein-api/Attributes/RequirePermissionAttribute.cs`

```csharp
[AttributeUsage(AttributeTargets.Method | AttributeTargets.Class)]
public class RequirePermissionAttribute : AuthorizeAttribute, IAuthorizationFilter
{
    private readonly string _permission;

    public RequirePermissionAttribute(string permission)
    {
        _permission = permission;
    }

    public void OnAuthorization(AuthorizationFilterContext context)
    {
        var user = context.HttpContext.User;
        
        if (!user.Identity?.IsAuthenticated ?? true)
        {
            context.Result = new UnauthorizedResult();
            return;
        }

        var permissions = user.Claims
            .Where(c => c.Type == "permission")
            .Select(c => c.Value)
            .ToList();

        if (!permissions.Contains(_permission))
        {
            context.Result = new ForbidResult();
        }
    }
}
```

### 4. Database Tablolarƒ± Ekle

**Yeni Migration:** `AddUserRolePermissionTables`

```sql
-- User tablosu
CREATE TABLE [dbo].[User] (
    [Id] INT IDENTITY(1,1) PRIMARY KEY,
    [Email] NVARCHAR(100) NOT NULL UNIQUE,
    [PasswordHash] NVARCHAR(255) NOT NULL,
    [MitgliedId] INT NULL,
    [Created] DATETIME NOT NULL DEFAULT GETDATE(),
    [Aktiv] BIT NOT NULL DEFAULT 1,
    CONSTRAINT FK_User_Mitglied FOREIGN KEY ([MitgliedId]) 
        REFERENCES [Mitglied].[Mitglied]([Id])
);

-- Role tablosu
CREATE TABLE [dbo].[Role] (
    [Id] INT IDENTITY(1,1) PRIMARY KEY,
    [Name] NVARCHAR(50) NOT NULL UNIQUE,
    [Description] NVARCHAR(255)
);

-- Permission tablosu
CREATE TABLE [dbo].[Permission] (
    [Id] INT IDENTITY(1,1) PRIMARY KEY,
    [Name] NVARCHAR(50) NOT NULL UNIQUE,
    [Description] NVARCHAR(255)
);

-- UserRole ili≈üki tablosu
CREATE TABLE [dbo].[UserRole] (
    [UserId] INT NOT NULL,
    [RoleId] INT NOT NULL,
    PRIMARY KEY ([UserId], [RoleId]),
    CONSTRAINT FK_UserRole_User FOREIGN KEY ([UserId]) 
        REFERENCES [dbo].[User]([Id]),
    CONSTRAINT FK_UserRole_Role FOREIGN KEY ([RoleId]) 
        REFERENCES [dbo].[Role]([Id])
);

-- RolePermission ili≈üki tablosu
CREATE TABLE [dbo].[RolePermission] (
    [RoleId] INT NOT NULL,
    [PermissionId] INT NOT NULL,
    PRIMARY KEY ([RoleId], [PermissionId]),
    CONSTRAINT FK_RolePermission_Role FOREIGN KEY ([RoleId]) 
        REFERENCES [dbo].[Role]([Id]),
    CONSTRAINT FK_RolePermission_Permission FOREIGN KEY ([PermissionId]) 
        REFERENCES [dbo].[Permission]([Id])
);

-- Seed data
INSERT INTO [Role] ([Name], [Description]) VALUES
    ('Admin', 'Sistem y√∂neticisi'),
    ('Dernek', 'Dernek y√∂neticisi'),
    ('Mitglied', 'Dernek √ºyesi');

INSERT INTO [Permission] ([Name], [Description]) VALUES
    ('verein.read', 'Dernek bilgilerini okuma'),
    ('verein.update', 'Dernek bilgilerini g√ºncelleme'),
    ('mitglied.all', '√úye t√ºm i≈ülemleri'),
    ('veranstaltung.all', 'Etkinlik t√ºm i≈ülemleri');
```

---

## üìÖ Uygulama Planƒ±

### Faz 1: Acil G√ºvenlik (1-2 g√ºn)
- [ ] JWT Authentication ekle
- [ ] Controller'lara `[Authorize]` attribute ekle
- [ ] Test et

### Faz 2: Yetki Sistemi (3-5 g√ºn)
- [ ] Database tablolarƒ±nƒ± olu≈ütur
- [ ] Entity modelleri ekle
- [ ] Migration olu≈ütur ve √ßalƒ±≈ütƒ±r
- [ ] Seed data ekle

### Faz 3: Permission Kontrol√º (2-3 g√ºn)
- [ ] `RequirePermissionAttribute` olu≈ütur
- [ ] Controller'lara permission attribute'larƒ± ekle
- [ ] JWT token'a permission claim'leri ekle
- [ ] Test et

### Faz 4: Test ve Dok√ºmantasyon (1-2 g√ºn)
- [ ] Unit testler yaz
- [ ] Integration testler yaz
- [ ] API dok√ºmantasyonu g√ºncelle
- [ ] Postman collection g√ºncelle

**Toplam S√ºre:** 7-12 g√ºn

---

## üéØ Sonu√ß

**Dernek y√∂neticisinin √ºye bilgilerini g√ºncelleme yetkisi VAR ama bu yetki KONTROL EDƒ∞LMƒ∞YOR!**

≈ûu an **herhangi bir kullanƒ±cƒ±** (hatta giri≈ü yapmamƒ±≈ü biri bile) t√ºm API endpoint'lerine eri≈üebilir. Bu **kritik bir g√ºvenlik a√ßƒ±ƒüƒ±dƒ±r** ve **acilen kapatƒ±lmalƒ±dƒ±r**.

---

## üìö Referanslar

- [ASP.NET Core Authentication](https://docs.microsoft.com/en-us/aspnet/core/security/authentication/)
- [ASP.NET Core Authorization](https://docs.microsoft.com/en-us/aspnet/core/security/authorization/)
- [JWT Bearer Authentication](https://jwt.io/)
- [OWASP API Security Top 10](https://owasp.org/www-project-api-security/)

---

**Not:** Bu analiz 2025-10-03 tarihinde yapƒ±lmƒ±≈ütƒ±r. Sistemde yapƒ±lan deƒüi≈üiklikler bu analizi ge√ßersiz kƒ±labilir.

